name: Unlock Dependent Issues

on:
  issues:
    types: [closed]

jobs:
  unlock-dependents:
    runs-on: ubuntu-latest
    steps:
      - name: Unlock dependent issues
        uses: actions/github-script@v7
        with:
          script: |
            const closedIssue = context.payload.issue.number;
            console.log(`Issue #${closedIssue} was closed`);

            // Dependency map: closed issue -> issues to potentially unlock
            const dependencies = {
              7: [9],           // Item Card -> Items Page
              8: [9],           // Expiry Badge -> Items Page
              9: [10, 11, 12, 13], // Items Page -> Suche, Filter, Sortierung
              14: [15, 16],     // Bottom Sheet -> Entnehmen, Teilentnahme
              15: [17],         // Komplett entnehmen -> Ausblenden
              18: [19],         // Logout Button -> Session Cleanup
              20: [21, 22, 23], // Categories Liste -> CRUD
              24: [25, 26, 27], // Locations Liste -> CRUD
              28: [29, 30, 31], // Users Liste -> CRUD
              32: [33, 34],     // Settings Liste -> Gefrierzeit, Smart Defaults
              37: [38],         // Dockerfile -> docker-compose
              38: [39],         // docker-compose -> Docs
            };

            // Combined dependencies: issue -> ALL required blockers
            const combinedDeps = {
              9: [7, 8],  // Items Page needs BOTH Item Card AND Expiry Badge
            };

            const dependents = dependencies[closedIssue];
            if (!dependents || dependents.length === 0) {
              console.log('No dependent issues to unlock');
              return;
            }

            console.log(`Checking dependents: ${dependents.join(', ')}`);

            for (const depIssue of dependents) {
              // Check if this issue has combined dependencies
              const requiredBlockers = combinedDeps[depIssue];

              if (requiredBlockers) {
                // Check if ALL blockers are closed
                let allClosed = true;
                for (const blocker of requiredBlockers) {
                  if (blocker === closedIssue) continue; // Skip the one we just closed

                  const { data: blockerIssue } = await github.rest.issues.get({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: blocker
                  });

                  if (blockerIssue.state !== 'closed') {
                    console.log(`#${depIssue} still blocked by open #${blocker}`);
                    allClosed = false;
                    break;
                  }
                }

                if (!allClosed) continue;
              }

              // Get current labels
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: depIssue
              });

              if (issue.state === 'closed') {
                console.log(`#${depIssue} is already closed, skipping`);
                continue;
              }

              const labels = issue.labels.map(l => l.name);
              const hasBlocked = labels.includes('status/blocked');
              const hasAgentReady = labels.includes('status/agent-ready');

              // Remove blocked, ensure agent-ready
              const newLabels = labels.filter(l => l !== 'status/blocked');
              if (!hasAgentReady) {
                newLabels.push('status/agent-ready');
              }

              if (hasBlocked || !hasAgentReady) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: depIssue,
                  labels: newLabels
                });
                console.log(`âœ“ Unlocked #${depIssue}`);

                // Add comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: depIssue,
                  body: `ðŸ”“ Automatisch freigeschaltet durch Abschluss von #${closedIssue}`
                });
              } else {
                console.log(`#${depIssue} was already unlocked`);
              }
            }
