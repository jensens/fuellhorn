name: Unlock Dependent Issues

on:
  issues:
    types: [closed]

jobs:
  unlock-dependents:
    runs-on: ubuntu-latest
    steps:
      - name: Unlock dependent issues
        uses: actions/github-script@v7
        with:
          script: |
            const closedIssue = context.payload.issue.number;
            console.log(`Issue #${closedIssue} was closed`);

            // Find all open issues that might be blocked by the closed issue
            const { data: allIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            // Pattern to find "Blocked by #X" in issue body
            const blockedByPattern = /[Bb]locked\s+by\s+#(\d+)/g;

            for (const issue of allIssues) {
              if (!issue.body) continue;

              // Find all blockers mentioned in this issue
              const blockers = [];
              let match;
              while ((match = blockedByPattern.exec(issue.body)) !== null) {
                blockers.push(parseInt(match[1]));
              }
              // Reset regex lastIndex for next iteration
              blockedByPattern.lastIndex = 0;

              // Skip if this issue doesn't reference the closed issue as blocker
              if (!blockers.includes(closedIssue)) continue;

              console.log(`#${issue.number} was blocked by #${closedIssue}, checking other blockers...`);

              // Check if all blockers are now closed
              let allBlockersClosed = true;
              for (const blockerId of blockers) {
                if (blockerId === closedIssue) continue;

                const { data: blockerIssue } = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: blockerId
                });

                if (blockerIssue.state !== 'closed') {
                  console.log(`  Still blocked by open #${blockerId}`);
                  allBlockersClosed = false;
                  break;
                }
              }

              if (!allBlockersClosed) continue;

              // All blockers are closed - unlock this issue!
              const labels = issue.labels.map(l => l.name);
              const hasBlocked = labels.includes('status/blocked');
              const hasAgentReady = labels.includes('status/agent-ready');

              if (hasBlocked || !hasAgentReady) {
                const newLabels = labels.filter(l => l !== 'status/blocked');
                if (!hasAgentReady) {
                  newLabels.push('status/agent-ready');
                }

                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: newLabels
                });

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `ðŸ”“ Automatisch freigeschaltet durch Abschluss von #${closedIssue}`
                });

                console.log(`âœ“ Unlocked #${issue.number}`);
              } else {
                console.log(`#${issue.number} was already unlocked`);
              }
            }

            console.log('Done!');
